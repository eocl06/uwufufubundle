<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UtopiArena - Turnuva</title>
    <link crossorigin href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Lexend:wght@400;500;700;900&family=Manrope:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABFSURBVDhPYxgFo2AUjIJRMDIgBaMWAMGWg40CGGARKIcFFhAFqiBELKwL0RAUEpZSYYAAKUmZASwYGLAESJgRKMIAAGVyBqwSAFXRAAAAAElFTkSuQmCC" type="image/x-icon"/>
    <style>
        body {
            min-height: 100dvh; /* Prefer dvh for dynamic viewport, but consider fallback */
            min-height: 100vh; /* Fallback for browsers not fully supporting dvh */
            font-family: 'Lexend', "Manrope", "Noto Sans", sans-serif;
            overscroll-behavior-y: contain;
            margin: 0;
            overflow-y: hidden; /* Allow y-scroll only if explicitly needed by a child */
            overflow-x: hidden; /* Prevent horizontal scroll */
            position: relative; /* For ensuring fixed elements are relative to body */
        }

        .hidden-screen {
            display: none !important;
        }

       .screen-content {
            height: 100dvh;
            overflow: hidden; /* scroll'u burada da engelle */
            padding: 0; /* boşlukları sıfırla */
            margin: 0;
        }

        /* Adjust padding for screens that sit above the bottom nav */
        #gameScreen, #resultsScreen, #finishScreen, #howToPlayScreen {
            /* padding-bottom is now handled dynamically by JS for main content areas */
            /* This ensures better compatibility with iOS address bar */
        }

        /* Adjust main content areas within screens to properly handle height */
        #gameScreen > div:nth-child(2), /* The main content flex-1 div in game screen */
        #resultsScreen main,
        #finishScreen .overflow-y-auto,
        #howToPlayScreen main {
            flex: 1; /* Allow these sections to grow and take available space */
            overflow-y: auto; /* Enable scrolling for main content areas */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        @keyframes backgroundMorph {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .background-animate {
            background: linear-gradient(270deg, #d1e4f0, #b8d8e8, #a3c9dc, #e0eaf0, #d1e4f0);
            background-size: 600% 600%;
            animation: backgroundMorph 12s ease infinite;
        }

        .start-button {
            background: linear-gradient(90deg, #76A9FA, #FF6F61);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .start-button:hover, .start-button:focus {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        #startGameButton {
            position: fixed;
            bottom: clamp(80px, 18vh, 150px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
        }
        .game-header-bar {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-left: 1.5rem;
            padding-right: 4.5rem;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: auto; /* Allow card to adjust to content */
            margin-bottom: 1rem; /* Add some space between cards on mobile */
            max-width: 90%; /* Limit card width on small screens relative to viewport */
            width: 100%; /* Ensure card takes full width of its container up to max-width */
        }
        .card.selected {
            transform: scale(1.05);
            z-index: 10;
        }
        .card.not-selected {
            opacity: 0;
            transform: translateX(100px);
        }

        .card-description-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4em;
            min-height: calc(1.4em * 2);
            max-height: calc(1.4em * 2 + 2px);
        }

        #winnerPopupDescription.card-description-clamp {
            -webkit-line-clamp: 4;
            max-height: calc(1.4em * 4 + 2px);
            min-height: auto;
        }

        #gameScreen .card .card-title {
            font-size: 1.125rem; /* text-xl */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.25em * 2 + 2px);
            min-height: calc(1.25em * 2);
        }
        .confetti-burst { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; background-image: radial-gradient(circle, rgba(255, 215, 0, 0.5) 0%, rgba(255, 215, 0, 0) 70%); border-radius: 50%; opacity: 0; animation: burst 0.7s ease-out forwards; z-index: 5; }
        @keyframes burst { 0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.5); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
        .progress-bar-spark { position: absolute; right: -5px; top: -3px; width: 10px; height: 10px; background-color: #FFD700; border-radius: 50%; box-shadow: 0 0 8px 2px #FFD700; opacity: 0; animation: pulse-spark 0.5s ease-in-out; }
        @keyframes pulse-spark { 0%, 100% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        #vsButtonSpan.vs-animate { animation: vsPulse 0.4s ease-in-out; }
        @keyframes vsPulse { 0% { transform: scale(1) rotate(-15deg); } 50% { transform: scale(1.3) rotate(5deg); } 100% { transform: scale(1) rotate(-15deg); } }
        @media (min-width: 768px) {
            #vsButtonSpan.vs-animate { animation: vsPulseDesktop 0.4s ease-in-out; }
            @keyframes vsPulseDesktop { 0% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.3) rotate(0deg); } 100% { transform: scale(1) rotate(0deg); } }
        }

        .final-match-theme { background-color: #2d3748 !important; }
        .final-match-theme .game-header-bar { background-color: #1a202c !important; }
        .final-match-theme #progressTextElement { color: #fbd38d !important; }
        .final-match-theme #progressBarFill { background-color: #FFD700 !important; }
        .final-match-theme .card {
            border: 2px solid #FFD700;
            box-shadow: 0 0 15px #FFD700;
            background-color: #374151;
        }
        .final-match-theme .card .card-title { color: #f3f4f6; }
        .final-match-theme .card .card-description { color: #9ca3af; }
        .final-match-theme #vsButtonSpan { background: linear-gradient(45deg, #FFD700, #fbd38d) !important; color: #1A202C !important; box-shadow: 0 0 10px #FFD700; }

        /* === SPONSORLU TEMA BAŞLANGICI === */
        .sponsored-round-theme { background-color: #F0F4F8 !important; } /* Daha temiz, hafif soğuk gri */
        .sponsored-round-theme .game-header-bar { background-color: #E1E8F0 !important; } /* Ana BG'den biraz koyu */
        .sponsored-round-theme #progressTextElement { color: #1E40AF !important; font-weight: bold !important; } /* Güçlü mavi (Tailwind blue-800) */
        .sponsored-round-theme #progressBarFill { background-color: #3B82F6 !important; } /* Canlı mavi (Tailwind blue-500) */
        .sponsored-round-theme .card {
            border: 1px solid #CBD5E0; /* İnce gri kenarlık (Tailwind gray-300) */
            background-color: #FFFFFF !important; /* Temiz beyaz */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04), 0 0 15px rgba(59, 130, 246, 0.25) !important; /* Standart gölge + mavi parlama */
        }
        .sponsored-round-theme .card .card-title { color: #1E3A8A !important; } /* Koyu mavi (Tailwind blue-800) */
        .sponsored-round-theme .card .card-description { color: #374151 !important; } /* Koyu gri (Tailwind gray-700) */
        .sponsored-round-theme #vsButtonSpan {
            background: linear-gradient(135deg, #3B82F6, #2563EB) !important; /* Mavi gradyan (blue-500 to blue-600) */
            color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 0 10px rgba(59, 130, 246, 0.3) !important; /* Hafif gölge + mavi parlama */
            border-radius: 9999px; /* Yuvarlaklığı garanti et */
            padding: 0.25rem 0.75rem !important; /* Padding ayarı */
            font-size: 0.8rem !important; /* Font boyutu */
        }
        /* === SPONSORLU TEMA BİTİŞİ === */

        .tournament-card-glow { box-shadow: 0 0 15px 5px rgba(66, 138, 239, 0.5), 0 0 30px 10px rgba(66, 138, 239, 0.3); animation: pulse-glow-qf 2s infinite; }
        .tournament-final-card-glow { background: linear-gradient(135deg, #fff1c0 0%, #ffe082 100%); box-shadow: 0 0 20px 8px rgba(255, 215, 0, 0.6), 0 0 40px 15px rgba(255, 215, 0, 0.4); }
        @keyframes pulse-glow-qf { 0% { box-shadow: 0 0 15px 5px rgba(66, 138, 239, 0.5), 0 0 30px 10px rgba(66, 138, 239, 0.3); } 50% { box-shadow: 0 0 25px 10px rgba(66, 138, 239, 0.7), 0 0 40px 15px rgba(66, 138, 239, 0.5); } 100% { box-shadow: 0 0 15px 5px rgba(66, 138, 239, 0.5), 0 0 30px 10px rgba(66, 138, 239, 0.3); } }

        .bg-hero-gradient { background-image: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,0.6)); }
        .gold-crown { color: #FFD700; }
        .material-icons, .material-icons-outlined { vertical-align: middle; }

        #bottomNav {
            height: 60px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevent navigation from shrinking */
        }
        #bottomNav a.active { color: #2563eb; }

        #globalHowToPlayButton { transition: background-color 0.2s, color 0.2s; }

        .modal-overlay {
            background-color: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); /* Safari support */
        }
        .modal-content-box {
            transform: scale(0.95);
            opacity: 0;
            transition-property: transform, opacity;
            transition-timing-function: ease-out;
            transition-duration: 300ms;
            width: calc(100% - 2rem); /* Add some horizontal padding */
            max-width: 480px; /* Limit max width for modals */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.08); /* Stronger shadow */
        }
        .modal-overlay.active { opacity: 1; }
        .modal-overlay.active .modal-content-box { transform: scale(1); opacity: 1; }

        @keyframes pulseTitle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }
        #startScreen h1 { animation: pulseTitle 4s ease-in-out infinite; }

        .image-h-winner-popup {
            height: 10.5rem;
            width: 100%; /* Ensure image fills its container */
            object-fit: cover; /* Maintain aspect ratio */
        }
        @media (min-width: 640px) {
            .image-h-winner-popup { height: 12.6rem; }
        }

        /* Game Screen specific layout for responsiveness */
        #gameScreen > div:nth-child(2) { /* flex-1 min-h-0 px-3 flex flex-col items-center justify-center */
            padding: 0 1rem; /* Consistent horizontal padding */
            display: flex;
            flex-direction: column; /* Stack cards vertically by default */
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }
        #gameScreen .flex-col.items-center { /* flex flex-col items-center @md:flex-row ... */
            width: 100%;
            max-width: 600px; /* Limit total width of card area */
            margin: auto; /* Center the card pair */
            box-sizing: border-box;
        }
        #gameScreen .card {
            /* Adjusted for tighter spacing on mobile */
            margin: 0.25rem 0; /* Further reduced space between cards on mobile from 0.5rem to 0.25rem */
            width: 100%;
            max-width: 380px; /* A reasonable max-width for individual cards on mobile */
        }

        /* Mobil (veya 768px altı tüm ekranlar) için VS butonunun etrafındaki boşluğu ayarla */
        #gameScreen .flex.items-center.justify-center.my-3 {
            margin-top: 0.5rem;    /* Reduced from my-3 (12px) to 0.5rem (8px) */
            margin-bottom: 0.5rem; /* Reduced from my-3 (12px) to 0.5rem (8px) */
        }
        #vsButtonSpan {
            /* No specific margin needed here as parent flex container handles spacing */
            /* Ensure it retains its original transform for mobile animation */
            transform: rotate(-15deg);
        }

        @media (min-width: 768px) {
            #gameScreen .flex-col.items-center {
                flex-direction: row; /* Cards side-by-side on desktop */
                justify-content: center;
                align-items: center;
                max-width: 800px; /* Wider for desktop */
            }
            #gameScreen .card {
                margin: 0 0.75rem; /* Space between cards on desktop (kept same as previous response) */
                max-width: 380px; /* Individual card width */
            }
            #gameScreen > div:nth-child(2) { /* main content area */
                transform: translateY(0); /* Remove mobile specific transform on desktop */
                padding-top: 1rem; /* Adjust padding if needed */
            }
            #gameScreen .flex.items.center.justify-center.my-3 {
                margin: 0 1rem; /* Space around VS on desktop (reduced from 1.5rem to 1rem) */
            }
            #vsButtonSpan {
                /* Ensure desktop specific transform */
                transform: rotate(0deg);
            }
        }

        /* Results Screen specific layout */
        #resultsScreen main {
            padding: 0 1rem; /* Consistent padding */
        }
        #resultsCardContainer {
            display: flex;
            flex-direction: column; /* Stack results cards vertically */
            align-items: center;
            padding-bottom: 1rem; /* Padding at the bottom of the scrollable area */
        }
        #championCardDisplay {
            width: calc(100% - 2rem); /* Account for padding */
            max-width: 450px; /* Max width for champion card */
            margin-bottom: 1.5rem; /* Space below champion card (increased slightly) */
        }
        #resultsCardContainer > div:not(#championCardDisplay) {
            width: calc(100% - 2rem);
            max-width: 400px;
            margin-top: 1rem; /* Space between other result cards */
        }

        @media (min-width: 768px) {
            #resultsCardContainer {
                flex-direction: row; /* Arrange side-by-side for desktop */
                flex-wrap: wrap; /* Allow wrapping */
                justify-content: center;
                align-items: flex-start; /* Align items to the top */
                gap: 1.5rem; /* Space between cards */
                padding-top: 1rem; /* Adjust padding for desktop */
            }
            #championCardDisplay {
                width: 30%; /* Adjust width for desktop layout */
                min-width: 280px;
                max-width: 400px;
                margin-bottom: 0; /* Remove mobile specific margin */
            }
            #resultsCardContainer > div:not(#championCardDisplay) {
                width: 25%; /* Adjust width for desktop layout */
                min-width: 250px;
                max-width: 300px;
                margin-top: 0; /* Remove mobile specific margin */
            }
        }

        /* Finish Screen specific layout */
        #finishScreen .flex-col.flex-1.min-h-0 {
            /* padding-bottom is handled by JS based on bottom nav */
        }
        #finishScreen .flex.overflow-x-auto {
            padding-right: 1.5rem; /* Adjust padding to match left */
            justify-content: flex-start; /* Align items to the start */
        }
        #moreDreamsContainer {
            justify-content: flex-start; /* Ensure alignment */
        }
        #moreDreamsContainer > div {
            flex-shrink: 0; /* Prevent items from shrinking */
            width: 280px; /* Fixed width for consistency */
            height: auto; /* Allow height to adjust */
        }

        /* Onboarding Modal specific styles */
        #onboardingHowToPlayModal main {
            max-height: 60vh; /* Set a max height for content to prevent overflow */
            overflow-y: auto; /* Enable scrolling for modal content */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling */
        }
        #onboardingHowToPlayContent ol {
            list-style: none; /* Remove default list style */
            padding-left: 0; /* Remove default padding */
        }
        #onboardingHowToPlayContent ol li {
            margin-bottom: 0.5rem; /* Space between list items */
        }

        /* Spinner veya yükleniyor efekti için */
        .image-loading {
            background-color: #e0e0e0; /* Gri bir arka plan */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" stroke="#cccccc" stroke-width="4" fill="none"/><path d="M25 5 A20 20 0 0 1 45 25" stroke="#999999" stroke-width="4" fill="none" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/></path></svg>'); /* Küçük bir SVG spinner */
            background-repeat: no-repeat;
            background-position: center;
            background-size: 30px 30px;
        }

        /* NEW: Loading Screen styles */
        .loading-screen-active {
            overflow: hidden !important;
        }

        #loadingScreen.active {
            opacity: 1;
            background: linear-gradient(270deg, #d1e4f0, #b8d8e8, #a3c9dc, #e0eaf0, #d1e4f0);
            background-size: 600% 600%;
            animation: backgroundMorph 12s ease infinite;
        }
    </style>
</head>
<body class="bg-[#FAF8F6]">

    <div id="loadingScreen" class="fixed inset-0 z-[200] flex items-center justify-center opacity-0 transition-opacity duration-500 ease-out hidden-screen">
        <div class="w-64">
            <h2 class="text-[#1a1a1a] text-xl font-bold text-center mb-4">Yükleniyor...</h2>
            <div class="h-2 rounded-full bg-[#cfd9e7] relative overflow-hidden">
                <div id="loadingProgressBarFill" class="h-full rounded-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-300 ease-out" style="width: 0%;"></div>
            </div>
            </div>
    </div>

    <div id="appContainer">
        <button id="globalHowToPlayButton" class="hidden-screen fixed top-3 right-3 z-40 text-slate-700 hover:text-blue-600">
            <span class="material-icons-outlined">help_outline</span>
        </button>

        <div id="startScreen" class="screen-content relative flex h-screen flex-col justify-center items-center group/design-root px-4 pt-6 pb-2 sm:pt-10 sm:pb-4 background-animate hidden-screen">
            <div class="flex flex-col items-center justify-center min-h-0 z-10 text-center mb-10 sm:mb-12">
                <h1 class="text-[#1a1a1a] tracking-tight text-[36px] sm:text-[52px] font-bold leading-tight pt-0 pb-1 sm:pb-2">Bir haberi gerçek kılabilsen, bu hangisi olsun isterdin?</h1>
                <p class="text-[#333333] text-base sm:text-lg font-normal leading-relaxed pb-3 sm:pb-4 max-w-md">Tüm Bundle kullanıcılarının seçimleriyle, Türkiye’nin en çok beklediği haberi birlikte belirliyoruz.</p>
            </div>
            <div class="w-full flex justify-center z-10 pb-0">
                <button id="startGameButton" class="start-button flex w-auto min-w-[180px] max-w-[320px] px-6 sm:px-8 h-12 sm:h-14 text-md sm:text-lg font-bold rounded-full shadow-lg items-center justify-center">
                    <span class="truncate">Oyuna Başla</span>
                </button>
            </div>
        </div>

        <div id="gameScreen" class="hidden-screen screen-content relative flex flex-col bg-slate-50">
            <div class="sticky top-0 z-20 bg-slate-50 shadow-sm game-header-bar">
                <p id="progressTextElement" class="text-[#0d131b] text-sm font-medium leading-normal truncate pr-8">Eleme: 1/8</p>
                <div class="h-1.5 rounded-full bg-[#cfd9e7] relative overflow-hidden mt-1">
                    <div id="progressBarFill" class="h-full rounded-full bg-[#428aef]" style="width: 0%;"></div>
                </div>
            </div>
            <div class="flex-1 min-h-0 px-3 flex flex-col items-center justify-center">
                <div class="flex flex-col items-center @md:flex-row @md:justify-center @md:items-center w-full">
                    <div class="card w-full max-w-md @md:max-w-sm bg-white rounded-xl shadow-xl overflow-hidden relative">
                        <div class="confetti-burst hidden"></div>
                        <div class="w-full overflow-hidden" style="height: 10.5rem;">
                            <img data-role="card-image-img" src="" alt="" class="w-full h-full object-cover">
                        </div>
                        <div class="p-4">
                            <h2 class="card-title text-[#0d131b] font-bold leading-tight mb-0.5"></h2>
                            <p class="card-description text-[#4c6c9a] text-sm font-normal leading-relaxed card-description-clamp"></p>
                        </div>
                    </div>
                    <div class="flex items-center justify-center my-3 @md:my-0 @md:mx-4">
                        <span id="vsButtonSpan" class="bg-[#428aef] text-white text-xs font-bold px-2 py-1 rounded-full shadow-md transform rotate-[-15deg] @md:rotate-0">VS</span>
                    </div>
                    <div class="card w-full max-w-md @md:max-w-sm bg-white rounded-xl shadow-xl overflow-hidden relative">
                        <div class="confetti-burst hidden"></div>
                        <div class="w-full overflow-hidden" style="height: 10.5rem;">
                            <img data-role="card-image-img" src="" alt="" class="w-full h-full object-cover">
                        </div>
                        <div class="p-4">
                            <h2 class="card-title text-[#0d131b] font-bold leading-tight mb-0.5"></h2>
                            <p class="card-description text-[#4c6c9a] text-sm font-normal leading-relaxed card-description-clamp"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="winnerPopupScreen" class="hidden-screen fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay opacity-0">
            <div id="winnerPopupContentContainer" class="modal-content-box bg-gray-800 rounded-xl shadow-2xl w-full max-w-md text-center text-white relative">
                <button id="closeWinnerPopupButton" class="absolute top-3 right-3 text-gray-400 hover:text-white z-10 p-1 rounded-full hover:bg-gray-700">
                    <span class="material-icons">close</span>
                </button>
                <div class="p-6 space-y-4">
                    <div class="mb-1"><span class="material-icons text-yellow-400 text-5xl sm:text-6xl">emoji_events</span></div>
                    <h2 class="text-2xl sm:text-3xl font-bold text-yellow-400">Senin Gelecek Dileğin!</h2>
                    <p id="winnerPopupSubtitle" class="text-sm sm:text-base text-gray-300 px-2">Turnuvanın sonunda senin seçtiğin dilek buydu. Belki bir gün gerçekten olur... ✨</p>
                    <div class="bg-gray-700 rounded-lg p-3 sm:p-4 border border-gray-600 shadow-md">
                        <img id="winnerPopupImage" src="" alt="Şampiyon Dilek" class="w-full image-h-winner-popup object-cover rounded-md mb-3 shadow-sm">
                        <h3 id="winnerPopupTitle" class="text-lg sm:text-xl font-semibold text-white mb-1"></h3>
                        <p id="winnerPopupDescription" class="text-xs sm:text-sm text-gray-300 card-description-clamp leading-relaxed"></p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-3">
                        <button id="winnerShareButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors text-sm sm:text-base flex items-center justify-center gap-2 shadow hover:shadow-md">
                            <span class="material-icons-outlined text-base">share</span> Şampiyonu Paylaş
                        </button>
                        <button id="winnerToResultsButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2.5 px-4 rounded-lg transition-colors text-sm sm:text-base shadow hover:shadow-md">
                            Sonuçları Keşfet →
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sponsoredPopupScreen" class="hidden-screen fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay opacity-0">
            <div id="sponsoredPopupContent" class="modal-content-box bg-sky-50 rounded-xl shadow-2xl w-full max-w-md text-center relative">
                <button id="closeSponsoredPopupButton" class="absolute top-3 right-3 text-slate-600 hover:text-slate-900 z-10 p-1 rounded-full hover:bg-slate-200 transition-colors">
                    <span class="material-icons">close</span>
                </button>
                <div class="p-6 space-y-4">
                    <h2 id="sponsoredPopupTitleText" class="text-xl sm:text-2xl font-bold text-slate-800">Sponsorlu İçerik</h2>
                    <img id="sponsoredPopupImage" src="" alt="Sponsorlu Reklam" class="w-full h-48 object-contain rounded-md mb-3 border border-slate-200">
                    <p id="sponsoredPopupDescriptionText" class="text-sm sm:text-base text-slate-600 px-2"></p>
                    <a id="sponsoredPopupLink" href="#" target="_blank" rel="noopener noreferrer" class="inline-block w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors text-base shadow-md hover:shadow-lg">
                        Hemen Keşfet!
                    </a>
                </div>
            </div>
        </div>

        <div id="resultsScreen" class="hidden-screen screen-content relative flex flex-col bg-slate-50">
            <div class="flex flex-col flex-1 min-h-0">
                <header class="sticky top-0 z-10 bg-slate-50/80 backdrop-blur-sm shadow-sm game-header-bar">
                    <div class="flex items-center justify-between relative">
                        <div class="w-10"></div>
                        <h1 class="text-slate-900 text-xl font-bold leading-tight text-center flex-grow">UtopiArena Sonuçları</h1>
                        <div class="w-10"></div>
                    </div>
                </header>
                <main class="pb-4 overflow-y-auto flex-1 min-h-0">
                    <h2 class="text-slate-800 text-2xl font-semibold leading-tight px-6 text-center pb-6 pt-5">Türkiye’nin Gelecek Hayali!</h2>
                    <div id="resultsCardContainer" class="px-4 space-y-4">
                        <div id="championCardDisplay" class="bg-white shadow-xl rounded-2xl overflow-hidden border-2 border-yellow-400 transform scale-105">
                            <div class="relative">
                                <img alt="Şampiyon dilek" id="championImageResults" class="w-full object-cover" style="height: 12.6rem;"/>
                                <div class="absolute inset-0 bg-hero-gradient"></div>
                                <div class="absolute top-2 right-2 gold-crown"><span class="material-icons" style="font-size: 36px;">emoji_events</span></div>
                                <div class="absolute bottom-0 left-0 p-4">
                                    <p id="championTitleResults" class="text-white text-3xl font-bold leading-tight"></p>
                                    <div class="flex items-center mt-2">
                                        <span class="material-icons text-red-400 mr-1" style="font-size: 20px;">favorite</span>
                                        <p id="championInfoResults" class="text-white text-base font-medium"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="finishScreen" class="hidden-screen screen-content relative flex flex-col bg-slate-50">
            <div class="flex flex-col flex-1 min-h-0">
                <header class="flex items-center bg-slate-50 p-3 justify-end sticky top-0 z-10 shadow-sm game-header-bar"></header>
                <div class="overflow-y-auto flex-1 min-h-0">
                    <div class="px-6 pt-6 pb-4 text-center">
                        <svg class="w-16 h-16 mx-auto text-yellow-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                        <h1 class="text-[#0d131b] text-3xl font-bold leading-tight pb-2">Türkiye’nin En Çok Beklenen Haberi Belli Oldu!</h1>
                        <p id="winningWishTextFinish" class="text-slate-600 text-lg font-normal leading-relaxed"></p>
                    </div>
                    <div class="flex flex-col gap-3 px-6 py-4">
                        <button id="shareChampionButton" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-6 flex-1 bg-[#428aef] text-slate-50 text-lg font-bold shadow-md hover:shadow-lg">
                            <span class="material-icons mr-2">share</span> <span class="truncate">Bu Haberi Paylaş</span>
                        </button>
                        <button id="finishPlayAgainButton" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-14 px-6 flex-1 bg-slate-200 text-[#0d131b] text-lg font-bold hover:bg-slate-300">
                            <span class="material-icons mr-2">replay</span> <span class="truncate">Yeni Bir Turnuva Başlat</span>
                        </button>
                    </div>
                    <div class="px-6 pt-8 pb-4"><h2 class="text-[#0d131b] text-2xl font-bold leading-tight">Diğer Popüler Hayaller...</h2></div>
                    <div class="flex overflow-x-auto [-ms-scrollbar-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden pl-6 pr-2 pb-6">
                        <div id="moreDreamsContainer" class="flex items-stretch gap-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="howToPlayScreen" class="hidden-screen screen-content relative flex flex-col bg-slate-50 p-0">
            <div class="flex flex-col flex-1 min-h-0">
                <header class="sticky top-0 z-10 bg-slate-50/80 backdrop-blur-sm py-2 px-4 shadow-sm game-header-bar">
                    <div class="flex items-center justify-between">
                        <h1 class="text-slate-900 text-xl font-bold leading-tight">Nasıl Oynanır?</h1>
                        <button id="closeHowToPlayButton" aria-label="Kapat" class="text-slate-700 flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-200 transition-colors">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    </div>
                </header>
                <main class="p-4 space-y-4 text-slate-700 overflow-y-auto flex-1 min-h-0">
                    <p class="text-lg">UtopiArena'ya hoş geldiniz!</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>Karşına çıkacak iki haberden, gerçekleşmesini en çok istediğini seç ve bir üst tura taşı.</li>
                        <li>Finale kadar ilerle ve Türkiye’nin en çok beklenen haberini birlikte belirleyelim.</li>
                        <li>Oyunu oynarken sağ üstteki <span class="material-icons-outlined text-sm">help_outline</span> butonuna tıklayarak bu ekrana her zaman dönebilirsin.</li>
                    </ol>
                    <p class="text-sm text-slate-500 mt-8 border-t border-slate-300 pt-4">
                        💡 Bu oyunda yer alan tüm haberler kurgusaldır. Gerçek kişi, kurum veya olaylarla hiçbir ilgisi yoktur.
                    </p>
                </main>
            </div>
        </div>

        <div id="onboardingHowToPlayModal" class="hidden-screen fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay opacity-0">
            <div id="onboardingModalBackdrop" class="fixed inset-0 transition-opacity duration-300 ease-out opacity-0 bg-slate-900/70 backdrop-blur-sm"></div>
            <div id="onboardingModalContent" class="modal-content-box bg-slate-50 rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative z-10">
                <header class="p-4 border-b border-slate-200"><h2 class="text-xl sm:text-2xl font-bold text-slate-800 text-center">UtopiArena'ya Hoş Geldin!</h2></header>
                <main id="onboardingHowToPlayContent" class="p-5 sm:p-6 space-y-3 text-slate-700 max-h-[60vh] sm:max-h-[65vh] overflow-y-auto">
                    <p class="text-base sm:text-lg font-semibold text-center text-blue-600">Gerçek olmasını istediğin habere oy ver!</p>
                    <ol class="list-none space-y-2 text-sm sm:text-base">
                        <li class="flex items-start"><span class="material-icons-outlined text-blue-500 mr-2 mt-0.5">looks_one</span><span>Sana sunulacak haber çiftleri arasından <strong class="text-slate-700">gerçekleşmesini en çok istediğini seç</strong>.</span></li>
                        <li class="flex items-start"><span class="material-icons-outlined text-blue-500 mr-2 mt-0.5">emoji_events</span><span>Seçimlerinle senaryolar finale kadar ilerlesin ve bir <strong class="text-yellow-500">şampiyon</strong> belirlensin!</span></li>
                        <li class="flex items-start"><span class="material-icons-outlined text-green-500 mr-2 mt-0.5">flag</span><span>Dilediğin geleceği seç ve <strong class="text-slate-700">ülkemizin en beklediği haberleri</strong> birlikte görelim!</span></li>
                    </ol>
                    <p class="text-xs text-slate-500 mt-4 border-t border-slate-300 pt-3">
                        <strong>Not:</strong> Oyundaki tüm senaryolar tamamen hayal ürünüdür. Daha detaylı "Nasıl Oynanır" bilgisine oyun içindeki <span class="material-icons-outlined text-xs align-bottom">help_outline</span> ikonundan her zaman ulaşabilirsin.
                    </p>
                </main>
                <footer class="p-4 bg-slate-100 border-t border-slate-200 text-center">
                    <button id="proceedFromOnboardingButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors text-base sm:text-lg shadow-md hover:shadow-lg">
                        Anladım, Oyuna Başla!
                    </button>
                </footer>
            </div>
        </div>

        <div id="stageTransitionModal" class="hidden-screen fixed inset-0 z-[150] flex items-center justify-center p-4 modal-overlay opacity-0">
            <div id="stageTransitionModalBackdrop" class="fixed inset-0 transition-opacity duration-300 ease-out opacity-0 bg-slate-900/75 backdrop-blur-md"></div>
            <div id="stageTransitionModalContent" class="modal-content-box bg-slate-800 text-white rounded-xl shadow-2xl w-full max-w-xs sm:max-w-sm text-center overflow-hidden relative z-10 p-4 sm:p-6">
                <span id="stageTransitionIcon" class="material-icons text-5xl sm:text-6xl mb-3 block text-yellow-400"></span>
                <h2 id="stageTransitionTitle" class="text-xl sm:text-2xl font-bold mb-2 text-yellow-400"></h2>
                <p id="stageTransitionMessage" class="text-sm sm:text-base text-slate-200"></p>
            </div>
        </div>

        <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-slate-50 border-t border-slate-200 z-30">
            <div class="flex justify-around items-center h-full max-w-2xl mx-auto px-1">
                <a id="navHomeButton" href="#" class="flex flex-col items-center justify-center gap-0.5 text-slate-600 hover:text-blue-600 transition-colors w-1/3 py-2 h-full">
                    <span class="material-icons-outlined">home</span><p class="text-xs font-medium tracking-tight">Anasayfa</p>
                </a>
                <a id="navPlayButton" href="#" class="flex flex-col items-center justify-center gap-0.5 text-slate-600 hover:text-blue-600 transition-colors w-1/3 py-2 h-full">
                    <span class="material-icons-outlined">casino</span><p class="text-xs font-medium tracking-tight">Oyna</p>
                </a>
                <a id="navResultsButton" href="#" class="flex flex-col items-center justify-center gap-0.5 text-slate-600 hover:text-blue-600 transition-colors w-1/3 py-2 h-full">
                    <span class="material-icons-outlined">emoji_events</span><p class="text-xs font-medium tracking-tight">Sonuçlar</p>
                </a>
            </div>
        </nav>
    </div>

<script>
    // ---------- DOM Elementleri ----------
    const screens = {
        start: document.getElementById('startScreen'),
        game: document.getElementById('gameScreen'),
        winnerPopup: document.getElementById('winnerPopupScreen'),
        results: document.getElementById('resultsScreen'),
        finish: document.getElementById('finishScreen'),
        howToPlay: document.getElementById('howToPlayScreen'),
        sponsoredPopup: document.getElementById('sponsoredPopupScreen')
    };
    const globalHowToPlayButton = document.getElementById('globalHowToPlayButton');
    const startGameButton = document.getElementById('startGameButton');
    const gameScreenCards = document.querySelectorAll('#gameScreen .card');
    const progressBarFill = document.getElementById('progressBarFill');
    const progressTextElement = document.getElementById('progressTextElement');
    const vsButtonSpan = document.getElementById('vsButtonSpan');

    const winnerPopupContentContainer = document.getElementById('winnerPopupContentContainer');
    const winnerPopupImage = document.getElementById('winnerPopupImage');
    const winnerPopupTitle = document.getElementById('winnerPopupTitle');
    const winnerPopupSubtitle = document.getElementById('winnerPopupSubtitle');
    const winnerPopupDescription = document.getElementById('winnerPopupDescription');
    const winnerToResultsButton = document.getElementById('winnerToResultsButton');
    const winnerShareButtonPopup = document.getElementById('winnerShareButton');
    const closeWinnerPopupButton = document.getElementById('closeWinnerPopupButton');

    const sponsoredPopupScreen = document.getElementById('sponsoredPopupScreen');
    const sponsoredPopupContent = document.getElementById('sponsoredPopupContent');
    const closeSponsoredPopupButton = document.getElementById('closeSponsoredPopupButton');
    const sponsoredPopupTitleText = document.getElementById('sponsoredPopupTitleText');
    const sponsoredPopupImage = document.getElementById('sponsoredPopupImage');
    const sponsoredPopupDescriptionText = document.getElementById('sponsoredPopupDescriptionText');
    const sponsoredPopupLink = document.getElementById('sponsoredPopupLink');

    const resultsCardContainer = document.getElementById('resultsCardContainer');
    const championCardDisplay = document.getElementById('championCardDisplay');
    const championImageResults = document.getElementById('championImageResults');
    const championTitleResults = document.getElementById('championTitleResults');
    const championInfoResults = document.getElementById('championInfoResults');
    const winningWishTextFinishElement = document.getElementById('winningWishTextFinish');
    const shareChampionButtonFinish = document.getElementById('shareChampionButton');
    const moreDreamsContainer = document.getElementById('moreDreamsContainer');
    const closeHowToPlayButton = document.getElementById('closeHowToPlayButton');
    const bottomNav = document.getElementById('bottomNav');
    const navHomeButton = document.getElementById('navHomeButton');
    const navPlayButton = document.getElementById('navPlayButton');
    const navResultsButton = document.getElementById('navResultsButton');

    const onboardingModal = document.getElementById('onboardingHowToPlayModal');
    const onboardingModalBackdrop = document.getElementById('onboardingModalBackdrop');
    const onboardingModalContent = document.getElementById('onboardingModalContent');
    const proceedFromOnboardingButton = document.getElementById('proceedFromOnboardingButton');

    const stageTransitionModal = document.getElementById('stageTransitionModal');
    const stageTransitionModalBackdrop = document.getElementById('stageTransitionModalBackdrop');
    const stageTransitionModalContent = document.getElementById('stageTransitionModalContent');
    const stageTransitionIcon = document.getElementById('stageTransitionIcon');
    const stageTransitionTitle = document.getElementById('stageTransitionTitle');
    const stageTransitionMessage = document.getElementById('stageTransitionMessage');

    // NEW: Loading Screen elements
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingProgressBarFill = document.getElementById('loadingProgressBarFill');
    // loadingProgressText is removed as requested


    const STAGES = {
        SEEDING: 'Eleme Turu', QUARTERFINALS: 'Çeyrek Final', SEMIFINALS: 'Yarı Final',
        FINAL: 'Final Maçı', RESULTS: 'Sonuçlar', FINISHED: 'Bitti', HOW_TO_PLAY: 'Nasıl Oynanır'
    };
    let currentScreenId = 'start'; // Uses keys from 'screens' object, e.g., 'start', 'game', 'howToPlay'
    let previousScreenId = 'start';
    let currentStage = STAGES.SEEDING;
    let currentMatchInStage = 0;
    let wishesForCurrentStage = [];
    let nextStageWishes = [];
    let voteCounts = {};
    let champion = null;
    let isSponsoredInterstitialActive = false;

    const SPONSORED_AD_DETAILS = {
        title: "Artık ikisi de ütopya değil!",
        description: "Samsung Bespoke AI Buzdolabı ile geleceğin teknolojileri evinize geldi.",
        image: "https://i.ibb.co/Kj70CdwF/image.png", imageSeed: null,
        link: "https://www.samsung.com/tr/home-appliances/bespoke-home/?gad_source=1&gad_campaignid=21450180449&gbraid=0AAAAAD2gkfW5E2S3kMwBuWPlYFKrdtHfP&gclid=CjwKCAjwi-DBBhA5EiwAXOHsGUZ_AI9UaOv6drI3rnMC15Ak3KhYxPdW7ZRU-lbD0FWs15154af7BoCwcQQAvD_BwE&gclsrc=aw.ds"
    };

    const wishes = [
        { id:1, title: "İzmir Belediyesi: Gece 00:00–05:00 Arası Ücretsiz Taksi Hizmeti Başladı", description: "Gece çalışan, okuyan ya da çıkan herkese bir tuşla güvenli ulaşım imkanı sunuluyor. ", imageSeed: "https://i.ibb.co/zhyF4pVq/Ads-z-tasar-m-4.png" },
        { id:2, title: "Türkiye’de Öğrencilere Aylık 2000 TL Kültür-Sanat Bütçesi Verilecek", description: "Sinema, tiyatro, konser ve kitap harcamalarında kullanılmak üzere öğrenci kartlarına aylık 2000 TL destek sağlanıyor.", imageSeed: "https://i.ibb.co/sd5ZCLLp/Ads-z-tasar-m-3.png" },
        { id:3, title: "Haluk Bilginer, Oscar Kazandı: “Yılın En İyi Yardımcı Erkek Oyuncusu”", description: "Sahnede yaptığı dokunaklı konuşmada Türkiye’ye selam gönderdi. Oyunculuk kariyerinde bir zirve daha: Dünya basını bu anı ayakta alkışladı.", imageSeed: "https://i.ibb.co/5X0C22T3/5.png" },
        { id:4, title: "Avrupa Birliği Türkiye’ye Vizeyi Kaldırdı", description: "2026’dan itibaren kimlik kartıyla serbest geçiş dönemi başlıyor. Vize randevu kuyruğu tarih oldu.", imageSeed: "https://i.ibb.co/BKY6x5d6/14.png" },
        { id:5, title: "WhatsApp’a “Yazdı Geri Sildi Ne Yazdı?” Özelliği Geldi", description: "Artık sildiği mesajı 5 saniyeliğine görebiliyorsun. “Az önce ne diyordun?” devri başladı, o büyük merak sonunda ortadan kalktı.", imageSeed: "https://i.ibb.co/84jDBzCZ/11.png" },
        { id:6, title: "Instagram “Yanlışlıkla Beğendiğin Fotoğrafı 10 Saniye İçinde Geri Al” Özelliğini Açtı", description: "2017 yılındaki bir fotoğrafa yanlışlıkla kalp bırakma kabusu bitti.", imageSeed: "https://i.ibb.co/BVsrTTNS/15.png" },
        { id:7, title: "İlk Türk Formula 1 Pilotu: 19 Yaşındaki Emir Aslan, Monza’da start aldı!", description: "Genç pilot ilk yarışında sekizinci sırada bitirerek puan almayı başardı. ", imageSeed: "https://i.ibb.co/mr6p5PNj/12.png" },
        { id:8, title: "Türkiye, Kadın-Erkek Eşitliği Endeksinde İlk 20’ye Girdi", description: "Eğitimde, iş hayatında ve evde kadın-erkek eşitliği uluslararası raporlarla tescillendi. ", imageSeed: "https://i.ibb.co/h19j4PMW/16.png" },
        { id:9, title: "Beren Yıldız, Nobel Fizik Ödülünü Kazandı: “Evrenin Nabzını Dinledik”", description: "ODTÜ’lü başarılı bilim kadını, kuantum kütleçekim alanındaki temel denklemi çözdü.", imageSeed: "https://i.ibb.co/wNd03smw/13.png" },
        { id:10, title: "Türkiye, 2029’da Eurovision’a Geri Döndü: Mabel Matiz Avrupa’yı Salladı", description: "Yarışmada seslendirdiği “Surface” adlı şarkısı, sahnede kullanılan ebru animasyonu ve etkileyici bağlama solosuyla tüm Avrupa’yı büyüledi.", imageSeed: "https://i.ibb.co/tPHmQTkx/1.png" },
        { id:11, title: "Haftada 4 Gün Çalışma Yasası Resmi Gazete’de Yayınlandı", description: "Artık cuma günü de resmi tatil ilan edildi. Aynı maaşla, daha az stresle yepyeni bir hayat başlıyor, genel iş-yaşam dengesi önemli ölçüde iyileşiyor.", imageSeed: "https://i.ibb.co/398Mt1t1/3.png" },
        { id:12, title: "Boğaziçi Üniversitesi, Dünya Üniversite Sıralamasında İlk 100’e Girdi!", description: "Times Higher Education'ın saygın listesine göre Türkiye’den ilk kez bir üniversite 98. sırada yer aldı. ", imageSeed: "https://i.ibb.co/JWwgJP6w/7.png" },
        { id:13, title: "Merkez Bankası, Enflasyon Tahminini %4’ten %3,5’e Düşürdü!", description: "Temel gıda ürünlerinde ve kiralarda belirgin bir düşüş başladı.", imageSeed: "https://i.ibb.co/4gfF8wJQ/6.png" },
        { id:14, title: "Türkiye’de Şehir Parkları ve Yeşil Alanlar 5 Yılda %42 Arttı", description: "Şehirlerde betonun yerini artık ağaç gölgeleri, otobüsün yerini ise bisiklet yolları aldı. ", imageSeed: "https://i.ibb.co/1fDFZcS9/9.png" },
        { id:15, title: "Türkiye, 2028 Avrupa Futbol Şampiyonu Oldu!", description: "Unutulmaz finalde Almanya’yı 3-2 yendik. Maçın 89. dakikasında Arda Güler'in attığı frikik golüyle millilerimiz tarih yazdı, tüm ülke büyük bir sevince boğuldu.", imageSeed: "https://i.ibb.co/KpGDpzbt/2.png" },
        { id:16, title: "Filenin Sultanları, Paris 2028’de Altın Madalya Kazandı!", description: "Nefes kesen finalde Brezilya’ya karşı alınan 3-1'lik skorla şampiyonluk geldi.", imageSeed: "https://i.ibb.co/nNNH3Lgb/Ads-z-tasar-m-2.png" }
    ];

    // Global cache for preloaded images
    let preloadedImagesCache = {};
    let imagesToPreloadQueue = []; // To store URLs for the initial loading screen

    function getImageUrl(imageIdentifier, width = 600, height = 400) {
        if (typeof imageIdentifier === 'string' && imageIdentifier.startsWith('http')) {
            return imageIdentifier;
        }
        const seed = imageIdentifier || `placeholder_${Math.random().toString(36).substring(7)}`;
        const url = `https://picsum.photos/seed/${seed}/${width}/${height}`;

        return url;
    }

    // Refactored preloadImages to return a Promise.
    // It no longer directly updates a loading bar for a fixed-duration animation.
    function preloadImages(imageUrls) {
        if (!imageUrls || imageUrls.length === 0) {
            return Promise.resolve(); // Immediately resolve if nothing to preload
        }

        const imagesToLoad = [...new Set(imageUrls)]; // Remove duplicates
        let loadedCount = 0;
        const totalImages = imagesToLoad.length;

        return new Promise(resolve => {
            if (totalImages === 0) {
                resolve();
                return;
            }

            imagesToLoad.forEach(imageUrl => {
                if (preloadedImagesCache[imageUrl] === true) {
                    loadedCount++;
                    if (loadedCount === totalImages) resolve();
                    return;
                } else if (preloadedImagesCache[imageUrl] === 'loading') {
                    // If already loading, we don't need to do anything here,
                    // its original Promise will handle resolution.
                    return;
                }

                const img = new Image();
                img.src = imageUrl;
                preloadedImagesCache[imageUrl] = 'loading'; // Mark as loading

                const onImageLoad = () => {
                    loadedCount++;
                    preloadedImagesCache[imageUrl] = true; // Mark as loaded
                    if (loadedCount === totalImages) resolve();
                };

                const onImageError = () => {
                    console.warn(`Failed to load image: ${imageUrl}`);
                    loadedCount++;
                    preloadedImagesCache[imageUrl] = false; // Mark as failed
                    if (loadedCount === totalImages) resolve();
                };

                img.onload = onImageLoad;
                img.onerror = onImageError;
            });
        });
    }

    // This function is no longer needed for a fixed-duration loading bar.
    // The bar's animation is now purely visual and controlled by CSS/setTimeout.
    // function updateLoadingProgressBar(loaded, total) { /* ... */ }

    // Function to load image and set src, handles blank until loaded and error states
    function loadImageAndSetSrc(imgElement, imageUrl, altText, errorPlaceholderUrl = null) {
        if (!imgElement) return;

        imgElement.classList.add('image-loading');
        imgElement.src = ''; // Clear existing src to prevent old image from showing
        imgElement.alt = altText || '';

        // Check if image is already in cache
        if (preloadedImagesCache[imageUrl] === true) {
            imgElement.src = imageUrl;
            imgElement.alt = altText;
            imgElement.classList.remove('image-loading'); // Remove spinner once loaded
        } else if (preloadedImagesCache[imageUrl] === false) { // Previously failed to load
            imgElement.src = errorPlaceholderUrl || 'https://via.placeholder.com/600x400?text=Görsel+Yüklenemedi'; // Use a generic error placeholder
            imgElement.alt = "Görsel yüklenemedi.";
            imgElement.classList.remove('image-loading'); // Remove spinner
        } else {
            const img = new Image();
            img.src = imageUrl;
            preloadedImagesCache[imageUrl] = 'loading'; // Mark as loading

            img.onload = () => {
                // Ensure imgElement hasn't been replaced or removed
                if (imgElement.src !== imageUrl) { // Only update if not already updated by another call
                    imgElement.src = imageUrl;
                    imgElement.alt = altText;
                }
                imgElement.classList.remove('image-loading'); // Remove spinner on successful load
                preloadedImagesCache[imageUrl] = true;
            };
            img.onerror = () => {
                console.warn(`Failed to load image: ${imageUrl}`);
                if (imgElement.src !== (errorPlaceholderUrl || 'https://via.placeholder.com/600x400?text=Görsel+Yüklenemedi')) {
                    imgElement.src = errorPlaceholderUrl || 'https://via.placeholder.com/600x400?text=Görsel+Yüklenemedi'; // Use a generic error placeholder
                    imgElement.alt = "Görsel yüklenemedi.";
                }
                imgElement.classList.remove('image-loading'); // Remove spinner on error
                preloadedImagesCache[imageUrl] = false;
            };
        }
    }


    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

    // Function to manage which images to preload based on the current screen
    function managePreloads(screenId) {
        let imagesToLoad = [];

        // Initial load / Start Screen / Onboarding: preload all 16 wishes and sponsored ad
        if (screenId === 'start' || screenId === 'onboardingHowToPlayModal' || screenId === 'loadingScreen') {
            wishes.slice(0, 16).forEach(w => {
                imagesToLoad.push(getImageUrl(w.imageSeed, 600, 400));
            });
            imagesToLoad.push(getImageUrl(SPONSORED_AD_DETAILS.imageSeed || SPONSORED_AD_DETAILS.image, 600, 300));
        }
        // In-game screen: preload next few matches
        else if (screenId === 'game') {
            const nextMatchesStartIndex = currentMatchInStage * 2 + 2;
            const preloadCount = (currentStage === STAGES.SEEDING) ? 8 : 4;
            const nextWishes = wishesForCurrentStage.slice(nextMatchesStartIndex, nextMatchesStartIndex + preloadCount);

            nextWishes.forEach(w => {
                imagesToLoad.push(getImageUrl(w.imageSeed, 600, 400));
            });

            if (currentStage === STAGES.SEMIFINALS || currentStage === STAGES.FINAL) {
                imagesToLoad.push(getImageUrl('champion_placeholder_final', 600, 400));
            }
        }
        // Results or Finish screen: preload specific results/finish images
        else if (screenId === 'results' || screenId === 'finish') {
            if (champion) {
                imagesToLoad.push(getImageUrl(champion.imageSeed, 600, 400));
            }
            const fixedOtherWishIds = [8, 13, 4, 14];
            fixedOtherWishIds.forEach(id => {
                const wish = wishes.find(w => w.id === id);
                if (wish && (!champion || wish.id !== champion.id)) {
                    imagesToLoad.push(getImageUrl(wish.imageSeed, 600, 300));
                }
            });
            const otherDreams = [...wishes].filter(w => w.id !== (champion ? champion.id : null));
            shuffleArray(otherDreams);
            for (let i = 0; i < Math.min(3, otherDreams.length); i++) {
                imagesToLoad.push(getImageUrl(otherDreams[i].imageSeed, 400, 225));
            }
        }

        imagesToLoad = [...new Set(imagesToLoad)];
        // If it's the initial loading screen, store URLs to preload.
        // Otherwise, just kick off preloading without waiting for it to finish.
        if (screenId === 'loadingScreen') {
            imagesToPreloadQueue = imagesToLoad;
        } else {
            preloadImages(imagesToLoad);
        }
    }

    function updateBottomNav() {
        if(navHomeButton) navHomeButton.classList.remove('active', 'text-blue-600');
        if(navPlayButton) navPlayButton.classList.remove('active', 'text-blue-600');
        if(navResultsButton) navResultsButton.classList.remove('active', 'text-blue-600');

        const isOverlayActive = (onboardingModal && !onboardingModal.classList.contains('hidden-screen')) ||
                                 (screens.winnerPopup && !screens.winnerPopup.classList.contains('hidden-screen')) ||
                                 (screens.sponsoredPopup && !screens.sponsoredPopup.classList.contains('hidden-screen')) ||
                                 (stageTransitionModal && !stageTransitionModal.classList.contains('hidden-screen')) ||
                                 (loadingScreen && !loadingScreen.classList.contains('hidden-screen')); // NEW: Include loadingScreen

        const navHeightWithSpace = '70px'; // Approx height of bottom nav + some buffer
        const screensThatNeedNavPadding = ['game', 'results', 'finish', 'howToPlay'];

        // Reset padding for all screens' main content areas
        Object.values(screens).forEach(screen => {
            if (screen) {
                const mainContentArea = screen.querySelector('main, .overflow-y-auto, .flex-1.min-h-0');
                if (mainContentArea) {
                    mainContentArea.style.paddingBottom = ''; // Reset
                }
            }
        });

        if (currentScreenId === 'start' || isOverlayActive) {
            if (navHomeButton) navHomeButton.classList.add('active', 'text-blue-600');
            if (bottomNav) bottomNav.classList.add('hidden-screen');
            if (globalHowToPlayButton) globalHowToPlayButton.classList.add('hidden-screen');
        } else {
            if (bottomNav) bottomNav.classList.remove('hidden-screen');

            if (globalHowToPlayButton) {
                globalHowToPlayButton.classList[currentScreenId !== 'howToPlay' ? 'remove' : 'add']('hidden-screen');
            }

            // Apply padding to the *scrollable content area* of the active screen
            if (screensThatNeedNavPadding.includes(currentScreenId)) {
                const activeScreen = screens[currentScreenId];
                if (activeScreen) {
                    const mainContentArea = activeScreen.querySelector('main, .overflow-y-auto, .flex-1.min-h-0');
                    if (mainContentArea) {
                        mainContentArea.style.paddingBottom = navHeightWithSpace;
                    }
                }
            }

            if (currentScreenId === 'game' && navPlayButton) navPlayButton.classList.add('active', 'text-blue-600');
            else if ((currentScreenId === 'results' || currentScreenId === 'finish') && navResultsButton) navResultsButton.classList.add('active', 'text-blue-600');
            else if (navHomeButton && !isOverlayActive && !screensThatNeedNavPadding.includes(currentScreenId) && currentScreenId !== 'howToPlay') navHomeButton.classList.add('active', 'text-blue-600');
        }
    }

    function showModal(modalElement, modalContentElement, backdropElement = null) {
        if (!modalElement || !modalContentElement) return;

        document.body.style.overflow = 'hidden'; // Disable body scroll when modal is active

        let tempPreviousScreenId = currentScreenId;
        modalElement.classList.remove('hidden-screen', 'opacity-0');
        modalElement.classList.add('flex', 'active', 'opacity-100');
        if (backdropElement) { backdropElement.classList.remove('opacity-0'); backdropElement.classList.add('opacity-100'); }
        currentScreenId = modalElement.id;
        updateBottomNav();
        // Only store previous screen if it's not another modal (including loading screen)
        if (!['onboardingHowToPlayModal', 'stageTransitionModal', 'winnerPopupScreen', 'sponsoredPopupScreen', 'loadingScreen'].includes(tempPreviousScreenId)) { // NEW: Include loadingScreen
            previousScreenId = tempPreviousScreenId;
        }
    }

    function hideModal(modalElement, modalContentElement, backdropElement = null, callback) {
        if (!modalElement || !modalContentElement) { if (callback) callback(); return; }

        modalElement.classList.remove('active', 'opacity-100');
        modalElement.classList.add('opacity-0');
        if (backdropElement) { backdropElement.classList.remove('opacity-100'); backdropElement.classList.add('opacity-0'); }
        setTimeout(() => {
            modalElement.classList.add('hidden-screen');
            modalElement.classList.remove('flex');
            // NEW: If the modal being hidden was the active screen, revert to previous non-modal screen
            if (currentScreenId === modalElement.id) currentScreenId = previousScreenId || 'start';
            document.body.style.overflow = 'hidden'; // Keep body overflow hidden as per game design for screens
            updateBottomNav();
            if (callback) callback();
        }, 300);
    }

    // showScreen fonksiyonu preloadları başlatacak şekilde güncelleniyor
    function showScreen(screenIdToShow) {
        let activeModal = null;
        if (onboardingModal && !onboardingModal.classList.contains('hidden-screen')) activeModal = { el: onboardingModal, content: onboardingModalContent, backdrop: onboardingModalBackdrop };
        else if (screens.winnerPopup && !screens.winnerPopup.classList.contains('hidden-screen')) activeModal = { el: screens.winnerPopup, content: winnerPopupContentContainer, backdrop: null };
        else if (screens.sponsoredPopup && !screens.sponsoredPopup.classList.contains('hidden-screen')) activeModal = { el: screens.sponsoredPopup, content: sponsoredPopupContent, backdrop: null };
        else if (stageTransitionModal && !stageTransitionModal.classList.contains('hidden-screen')) activeModal = { el: stageTransitionModal, content: stageTransitionModalContent, backdrop: stageTransitionModalBackdrop };
        else if (loadingScreen && !loadingScreen.classList.contains('hidden-screen')) activeModal = { el: loadingScreen, content: loadingProgressBarFill, backdrop: null }; // NEW: Add loadingScreen to activeModal check

        const displayActualScreen = () => {
            if (screenIdToShow === 'onboardingModal') { showModal(onboardingModal, onboardingModalContent, onboardingModalBackdrop); managePreloads(screenIdToShow); return; }
            if (screenIdToShow === 'winnerPopup') { displayWinnerPopupContent(); showModal(screens.winnerPopup, winnerPopupContentContainer); managePreloads(screenIdToShow); return; }
            if (screenIdToShow === 'sponsoredPopup') {
                if(sponsoredPopupTitleText) sponsoredPopupTitleText.textContent = SPONSORED_AD_DETAILS.title;
                if(document.getElementById('sponsoredPopupImage')) loadImageAndSetSrc(document.getElementById('sponsoredPopupImage'), getImageUrl(SPONSORED_AD_DETAILS.imageSeed || SPONSORED_AD_DETAILS.image), "Sponsorlu Reklam");
                if(sponsoredPopupDescriptionText) sponsoredPopupDescriptionText.textContent = SPONSORED_AD_DETAILS.description;
                if(sponsoredPopupLink) sponsoredPopupLink.href = SPONSORED_AD_DETAILS.link;
                showModal(screens.sponsoredPopup, sponsoredPopupContent); managePreloads(screenIdToShow); return;
            }
            if (!screens[screenIdToShow]) { console.error("Ekran bulunamadı:", screenIdToShow); return; }

            // NEW: Only store previous screen if it's not another overlay/modal
            if (currentScreenId !== screenIdToShow && screens[currentScreenId] && !['onboardingHowToPlayModal', 'stageTransitionModal', 'winnerPopupScreen', 'sponsoredPopupScreen', 'loadingScreen'].includes(screens[currentScreenId].id)) {
                previousScreenId = currentScreenId;
            }

            Object.values(screens).forEach(screen => { if(screen && screen.id !== screens[screenIdToShow].id) screen.classList.add('hidden-screen'); });
            screens[screenIdToShow].classList.remove('hidden-screen');
            currentScreenId = screenIdToShow;

            const bodyClassList = document.body.classList;
            if (screens.game) screens.game.classList.remove('final-match-theme', 'sponsored-round-theme');
            bodyClassList.remove('background-animate', 'bg-[#FAF8F6]', 'bg-slate-50', 'bg-slate-100', 'bg-[#F0F4F8]', 'bg-slate-800', 'loading-screen-active'); // NEW: Remove loading-screen-active

            if (screenIdToShow === 'start') bodyClassList.add('background-animate', 'bg-[#FAF8F6]');
            else if (screens[screenIdToShow]) {
                if (screenIdToShow === 'game') {
                    if (currentStage === STAGES.FINAL) {
                        screens.game.classList.add('final-match-theme');
                        bodyClassList.add('bg-slate-800');
                    } else if (isSponsoredInterstitialActive) {
                        screens.game.classList.add('sponsored-round-theme');
                        bodyClassList.add('bg-[#F0F4F8]');
                    } else {
                        bodyClassList.add('bg-slate-50');
                    }
                } else {
                    let screenBg = 'bg-slate-50';
                    if (screens[screenIdToShow].classList.contains('bg-[#FAF8F6]')) screenBg = 'bg-[#FAF8F6]';
                    else if (screens[screenIdToShow].classList.contains('bg-slate-50')) screenBg = 'bg-slate-50';
                    bodyClassList.add(screenBg);
                }
            }
            updateBottomNav();
            window.scrollTo(0,0);
            managePreloads(screenIdToShow); // Preload next images while playing current match
        };

        // NEW: Check if an active modal needs to be hidden first
        if (activeModal && activeModal.el.id !== (screens[screenIdToShow] ? screens[screenIdToShow].id : screenIdToShow) ) {
            hideModal(activeModal.el, activeModal.content, activeModal.backdrop, displayActualScreen);
        } else {
            displayActualScreen();
        }
    }

    function resetGameAndPlay(showOnboarding = false) {
        currentStage = STAGES.SEEDING; currentMatchInStage = 0; nextStageWishes = []; voteCounts = {}; champion = null; isSponsoredInterstitialActive = false;
        localStorage.removeItem('sponsoredRoundShownThisSession'); // Reset sponsor ad state for new game
        let wishesForSeeding = [...wishes]; shuffleArray(wishesForSeeding); wishesForCurrentStage = wishesForSeeding.slice(0, 16);
        if (screens.game) screens.game.classList.remove('sponsored-round-theme', 'final-match-theme');
        if (showOnboarding) {
            showScreen('onboardingModal'); // This will set currentScreenId to 'onboardingHowToPlayModal'
        } else {
            updateProgressBar(); // Ensure progress bar is reset/updated
            loadNextMatchUI();    // Load initial match UI
            showScreen('game');   // Then show the game screen
        }
    }

    function getMatchPair() {
        if (wishesForCurrentStage.length < (currentMatchInStage * 2) + 2) return [null, null];
        return [wishesForCurrentStage[currentMatchInStage * 2], wishesForCurrentStage[(currentMatchInStage * 2) + 1]];
    }

    function showSponsoredInterstitial() {
        isSponsoredInterstitialActive = true; localStorage.setItem('sponsoredRoundShownThisSession', 'true');
        if (screens.game) {
            screens.game.classList.remove('final-match-theme');
            screens.game.classList.add('sponsored-round-theme');
            document.body.classList.remove('bg-slate-50', 'bg-[#FAF8F6]');
            document.body.classList.add('bg-[#F0F4F8]');
        }
        if (progressTextElement) progressTextElement.textContent = "Sponsorlu Etap";
        if (progressBarFill) progressBarFill.style.width = `${(4 / 8) * 100}%`;
        const sponsoredCardContent1 = { id: 'sp_card_1', title: "Ne Pişireceğinize Artık Buzdolabımız Karar Verebilecek!", description: "AI destekli buzdolabı, içerikteki malzemelere göre her gün yeni tarif öneriyor.", imageSeed: "https://i.ibb.co/zhQtLZp2/10.png" };
        const sponsoredCardContent2 = { id: 'sp_card_2', title: "İçindekileri Tanıyan ve Alışveriş Listesi Hazırlayan Buzdolabı duyuruldu! ", description: "Yapay zekâlı buzdolabı, eksikleri algılayıp ihtiyacın olan ürünleri liste halinde bildiriyor.", imageSeed: "https://i.ibb.co/sphC2bqB/8.png" };

        const card1TitleEl = gameScreenCards[0].querySelector('.card-title');
        const card1DescEl = gameScreenCards[0].querySelector('.card-description');
        const card1ImgEl = gameScreenCards[0].querySelector('img[data-role="card-image-img"]');
        if (card1TitleEl) card1TitleEl.textContent = sponsoredCardContent1.title;
        if (card1DescEl) card1DescEl.textContent = sponsoredCardContent1.description;
        loadImageAndSetSrc(card1ImgEl, getImageUrl(sponsoredCardContent1.imageSeed), sponsoredCardContent1.title);
        gameScreenCards[0].dataset.wishId = sponsoredCardContent1.id;

        const card2TitleEl = gameScreenCards[1].querySelector('.card-title');
        const card2DescEl = gameScreenCards[1].querySelector('.card-description');
        const card2ImgEl = gameScreenCards[1].querySelector('img[data-role="card-image-img"]');
        if (card2TitleEl) card2TitleEl.textContent = sponsoredCardContent2.title;
        if (card2DescEl) card2DescEl.textContent = sponsoredCardContent2.description;
        loadImageAndSetSrc(card2ImgEl, getImageUrl(sponsoredCardContent2.imageSeed), sponsoredCardContent2.title);
        gameScreenCards[1].dataset.wishId = sponsoredCardContent2.id;

        if (vsButtonSpan) { vsButtonSpan.classList.remove('vs-animate'); void vsButtonSpan.offsetWidth; vsButtonSpan.classList.add('vs-animate'); }
        gameScreenCards.forEach(c => { c.classList.remove('selected', 'not-selected'); c.style.pointerEvents = 'auto'; c.querySelector('.confetti-burst')?.classList.add('hidden'); c.style.visibility = 'visible';});
        showScreen('game');
    }

    function advanceToNextStage() {
        currentMatchInStage = 0; wishesForCurrentStage = [...nextStageWishes]; shuffleArray(wishesForCurrentStage); nextStageWishes = [];
        let nextLogicalStage = null;
        switch (currentStage) {
            case STAGES.SEEDING: nextLogicalStage = STAGES.QUARTERFINALS; break;
            case STAGES.QUARTERFINALS: nextLogicalStage = STAGES.SEMIFINALS; break;
            case STAGES.SEMIFINALS: nextLogicalStage = STAGES.FINAL; break;
            default: if (champion) displayResultsScreen(); else resetGameAndPlay(); return;
        }
        currentStage = nextLogicalStage;
        isSponsoredInterstitialActive = false;
        if (screens.game) screens.game.classList.remove('sponsored-round-theme');

        const showNextMatchSetup = () => {
            updateProgressBar();
            if (wishesForCurrentStage.length >= 2 || (currentStage === STAGES.FINAL && wishesForCurrentStage.length === 2) ) {
                loadNextMatchUI(); // This function will populate cards and make them visible
                showScreen('game');
            }
            else if (wishesForCurrentStage.length === 1 && currentStage !== STAGES.FINAL) { // Only one winner, so they are the champion
                champion = wishesForCurrentStage[0];
                currentStage = STAGES.FINAL; // Even if it's not a match, set stage to final to show winner popup
                currentMatchInStage = 1; // Mark as finished for progress bar
                updateProgressBar();
                showScreen('winnerPopup');
            }
            else { console.error("Not enough wishes for current stage:", currentStage, wishesForCurrentStage); resetGameAndPlay(); return; }
        };
        let iconName = '', title = '', message = '', showTransition = false;
        if (currentStage === STAGES.QUARTERFINALS) { iconName = 'sports_score'; title = 'Çeyrek Finaller!'; message = 'En iyi hayaller bir üst tura yükseldi. Mücadele devam ediyor!'; showTransition = true; }
        else if (currentStage === STAGES.SEMIFINALS) { iconName = 'stars'; title = 'Yarı Finaller!'; message = 'Şampiyonluğa çok az kaldı! Son hayaller yarışıyor.'; showTransition = true; }
        else if (currentStage === STAGES.FINAL) { iconName = 'emoji_events'; title = 'BÜYÜK FİNAL!'; message = 'İşte şampiyonu belirleyecek o efsanevi karşılaşma!'; showTransition = true; }

        if (showTransition && stageTransitionModal) {
            // Temporarily hide cards before showing transition modal
            gameScreenCards.forEach(card => {
                card.style.visibility = 'hidden';
            });

            if(stageTransitionIcon) stageTransitionIcon.textContent = iconName;
            if(stageTransitionTitle) stageTransitionTitle.textContent = title;
            if(stageTransitionMessage) stageTransitionMessage.textContent = message;
            showModal(stageTransitionModal, stageTransitionModalContent, stageTransitionModalBackdrop);
            setTimeout(() => {
                hideModal(stageTransitionModal, stageTransitionModalContent, stageTransitionModalBackdrop, showNextMatchSetup);
            }, 1250); // Timeout for transition message
        } else {
            showNextMatchSetup();
        }
    }

    function loadNextMatchUI() {
        if (currentStage === STAGES.SEEDING && currentMatchInStage === 4 && !localStorage.getItem('sponsoredRoundShownThisSession')) { showSponsoredInterstitial(); return; }

        if (isSponsoredInterstitialActive && screens.game && !screens.game.classList.contains('sponsored-round-theme')) {
            screens.game.classList.remove('final-match-theme');
            screens.game.classList.add('sponsored-round-theme');
            document.body.classList.remove('bg-slate-50', 'bg-[#FAF8F6]');
            document.body.classList.add('bg-[#F0F4F8]');
        } else if (!isSponsoredInterstitialActive && currentStage !== STAGES.FINAL && screens.game) {
            screens.game.classList.remove('sponsored-round-theme', 'final-match-theme');
            document.body.classList.remove('bg-[#F0F4F8]', 'bg-slate-800'); // final match body bg
            document.body.classList.add('bg-slate-50');
        } else if (currentStage === STAGES.FINAL && screens.game) {
            screens.game.classList.remove('sponsored-round-theme');
            screens.game.classList.add('final-match-theme');
            document.body.classList.remove('bg-slate-50','bg-[#FAF8F6]', 'bg-[#F0F4F8]');
            document.body.classList.add('bg-slate-800'); // Set dark background for final match
        }

        const [wish1, wish2] = getMatchPair();
        if (!wish1 || !wish2) {
            advanceToNextStage();
            return;
        }
        if (vsButtonSpan) { vsButtonSpan.classList.remove('vs-animate'); void vsButtonSpan.offsetWidth; vsButtonSpan.classList.add('vs-animate'); }

        const card1TitleEl = gameScreenCards[0].querySelector('.card-title');
        const card1DescEl = gameScreenCards[0].querySelector('.card-description');
        const card1ImgEl = gameScreenCards[0].querySelector('img[data-role="card-image-img"]');
        if (card1TitleEl) card1TitleEl.textContent = wish1.title;
        if (card1DescEl) card1DescEl.textContent = wish1.description;
        gameScreenCards[0].dataset.wishId = wish1.id;
        loadImageAndSetSrc(card1ImgEl, getImageUrl(wish1.imageSeed), wish1.title);


        const card2TitleEl = gameScreenCards[1].querySelector('.card-title');
        const card2DescEl = gameScreenCards[1].querySelector('.card-description');
        const card2ImgEl = gameScreenCards[1].querySelector('img[data-role="card-image-img"]');
        if (card2TitleEl) card2TitleEl.textContent = wish2.title;
        if (card2DescEl) card2DescEl.textContent = wish2.description;
        gameScreenCards[1].dataset.wishId = wish2.id;
        loadImageAndSetSrc(card2ImgEl, getImageUrl(wish2.imageSeed), wish2.title);

        gameScreenCards.forEach(c => {
            c.classList.remove('selected', 'not-selected');
            c.style.pointerEvents = 'auto';
            c.querySelector('.confetti-burst')?.classList.add('hidden');
            c.style.visibility = 'visible'; // Make cards visible after new content is loaded
        });
        managePreloads('game'); // Preload next images while playing current match
    }


    function updateProgressBar() {
        if (isSponsoredInterstitialActive) {
            if (progressTextElement) progressTextElement.textContent = "Sponsorlu Etap"; if (progressBarFill) progressBarFill.style.width = `${(4/8)*100}%`;
            const oldSpark = progressBarFill.querySelector('.progress-bar-spark'); if (oldSpark) oldSpark.remove(); return;
        }
        let totalMatches = 0, stageName = currentStage, matchNum = currentMatchInStage + 1;
        if (currentStage === STAGES.SEEDING) { totalMatches = wishesForCurrentStage.length / 2; stageName = "Eleme"; }
        else if (currentStage === STAGES.QUARTERFINALS) { totalMatches = wishesForCurrentStage.length / 2; stageName = "Ç.Final"; }
        else if (currentStage === STAGES.SEMIFINALS) { totalMatches = wishesForCurrentStage.length / 2; stageName = "Y.Final"; }
        else if (currentStage === STAGES.FINAL) { totalMatches = 1; stageName = "FİNAL!"; } else return;
        if (currentMatchInStage >= totalMatches && totalMatches > 0) matchNum = totalMatches;
        const progress = totalMatches > 0 ? (currentMatchInStage / totalMatches) * 100 : 0;
        if (progressBarFill) progressBarFill.style.width = `${Math.min(progress, 100)}%`;
        if (progressTextElement) {
            if (currentStage === STAGES.FINAL && currentMatchInStage === 0 && progress < 100) progressTextElement.textContent = stageName;
            else if (progress >= 100 && currentStage === STAGES.FINAL) progressTextElement.textContent = "ŞAMPİYON!";
            else progressTextElement.textContent = `${stageName}: ${matchNum}/${totalMatches}`;
        }
        if (matchNum > 0 && totalMatches > 0 && progressBarFill) {
            const oldSpark = progressBarFill.querySelector('.progress-bar-spark'); if (oldSpark) oldSpark.remove();
            const spark = document.createElement('div'); spark.className = 'progress-bar-spark';
            let sparkPos = (matchNum / totalMatches * 100);
            if (currentMatchInStage >= totalMatches) sparkPos = 100; else if (progress >= 100 && currentMatchInStage < totalMatches) sparkPos = 99; // Ensure spark doesn't go way past if logic is slightly off
            spark.style.left = `calc(${Math.min(sparkPos,100)}% - 5px)`; progressBarFill.appendChild(spark);
            setTimeout(() => { if(spark.parentElement) spark.remove(); }, 500);
        }
    }

    function handleCardSelection(selectedCardNode) {
        if (isSponsoredInterstitialActive) {
            if(sponsoredPopupTitleText) sponsoredPopupTitleText.textContent = SPONSORED_AD_DETAILS.title;
            if(document.getElementById('sponsoredPopupImage')) loadImageAndSetSrc(document.getElementById('sponsoredPopupImage'), getImageUrl(SPONSORED_AD_DETAILS.imageSeed || SPONSORED_AD_DETAILS.image), "Sponsorlu Reklam");
            if(sponsoredPopupDescriptionText) sponsoredPopupDescriptionText.textContent = SPONSORED_AD_DETAILS.description;
            if(sponsoredPopupLink) sponsoredPopupLink.href = SPONSORED_AD_DETAILS.link;
            showModal(screens.sponsoredPopup, sponsoredPopupContent); return;
        }
        gameScreenCards.forEach(c => c.style.pointerEvents = 'none'); // Disable clicks on cards temporarily
        selectedCardNode.classList.add('selected'); // Highlight selected card

        const chosenId = selectedCardNode.dataset.wishId;
        const winner = wishes.find(w => w.id == chosenId);

        if (currentStage === STAGES.FINAL) {
            champion = winner;
            currentMatchInStage++;
            updateProgressBar();
            setTimeout(()=> {
                showScreen('winnerPopup');
            }, 1000); // Show winner popup after a short delay
            return;
        }

        if (winner) nextStageWishes.push(winner);
        if (currentStage === STAGES.SEEDING) voteCounts[chosenId] = (voteCounts[chosenId] || 0) + 1; // Track votes only in seeding round

        // Show confetti on selected card
        const confetti = selectedCardNode.querySelector('.confetti-burst');
        if (confetti) {
            confetti.classList.remove('hidden');
            setTimeout(() => confetti.classList.add('hidden'), 700); // Hide confetti after animation
        }

        // Fade out non-selected card
        gameScreenCards.forEach(oc => {
            if (oc !== selectedCardNode) oc.classList.add('not-selected');
        });

        setTimeout(() => {
            currentMatchInStage++;
            updateProgressBar();

            let totalMatchesInThisStage = 0;
            if (currentStage === STAGES.SEEDING) totalMatchesInThisStage = wishesForCurrentStage.length / 2;
            else if (currentStage === STAGES.QUARTERFINALS) totalMatchesInThisStage = wishesForCurrentStage.length / 2;
            else if (currentStage === STAGES.SEMIFINALS) totalMatchesInThisStage = wishesForCurrentStage.length / 2;

            if (currentMatchInStage >= totalMatchesInThisStage && currentStage !== STAGES.FINAL) {
                advanceToNextStage(); // Move to the next stage
            } else if (currentStage !== STAGES.FINAL) {
                loadNextMatchUI(); // Load the next match in the current stage
            }
        }, 1000); // Delay before moving to the next match or stage
    }

    function displayWinnerPopupContent() {
        if (!champion) {
            console.warn("Şampiyon popup için şampiyon belirlenmedi. Fallback.");
            // Try to find a champion if not explicitly set (e.g., direct navigation to results)
            const sortedByVotes = Object.keys(voteCounts).sort((a,b) => voteCounts[b] - voteCounts[a]);
            if (sortedByVotes.length > 0) champion = wishes.find(w => w.id == sortedByVotes[0]);
            else if (wishes.length > 0) champion = wishes[0]; // Fallback to first available wish
            else {
                if(winnerPopupTitle) winnerPopupTitle.textContent = "Hata!";
                if(winnerPopupDescription) winnerPopupDescription.textContent = "Şampiyon bulunamadı.";
                loadImageAndSetSrc(winnerPopupImage, getImageUrl('error_placeholder_results', 600, 400), "Error");
                return;
            }
        }
        if(winnerPopupSubtitle) winnerPopupSubtitle.textContent = `Turnuvanın sonunda senin seçtiğin dilek buydu. Belki bir gün gerçekten olur... ✨`;
        if(winnerPopupTitle) winnerPopupTitle.textContent = champion.title;
        if(winnerPopupDescription) winnerPopupDescription.textContent = champion.description;
        loadImageAndSetSrc(winnerPopupImage, getImageUrl(champion.imageSeed), champion.title);
    }

    function displayResultsScreen() {
        const totalSeedingVotes = Object.values(voteCounts).reduce((sum, count) => sum + count, 0);
        if (!champion) {
            // Attempt to determine champion from vote counts if not set
            const sortedByVotes = Object.keys(voteCounts).sort((a,b) => voteCounts[b] - voteCounts[a]);
            if (sortedByVotes.length > 0) champion = wishes.find(w => w.id == sortedByVotes[0]);
            if (!champion && wishes.length > 0) champion = wishes[0]; // Fallback if no votes or champion
            else if (!champion) { console.error("Sonuç ekranı için şampiyon belirlenemedi."); showScreen('results'); return; } // Still no champion, show empty results
        }
        const championVoteCount = voteCounts[champion.id] || 0;
        const championPercentage = totalSeedingVotes > 0 ? ((championVoteCount / totalSeedingVotes) * 100).toFixed(1) : "0.0";

        if(championTitleResults) championTitleResults.textContent = champion.title;
        if(championInfoResults) championInfoResults.textContent = `Tercih edilme oranı: %${championPercentage}`;
        loadImageAndSetSrc(championImageResults, getImageUrl(champion.imageSeed, 600, 400), champion.title);

        if(resultsCardContainer && championCardDisplay) {
            resultsCardContainer.innerHTML = ''; // Clear previous results
            resultsCardContainer.appendChild(championCardDisplay); // Add champion card first

            const fixedOtherWishIds = [8, 13, 4, 14];
            const otherWishesToDisplay = fixedOtherWishIds.map(id => {
                if (champion && id === champion.id) return null; // Don't show champion again if it's in fixed list
                const wish = wishes.find(w => w.id === id);
                if (!wish) return null;
                return { ...wish, voteCount: voteCounts[id] || 0 };
            }).filter(w => w); // Remove nulls

            otherWishesToDisplay.slice(0, 3).forEach(w => { // Show up to 3 other wishes
                if (!w || typeof w.voteCount === 'undefined') return;
                const wishPercentage = totalSeedingVotes > 0 ? ((w.voteCount / totalSeedingVotes) * 100).toFixed(1) : "0.0";
                const otherImageUrl = getImageUrl(w.imageSeed, 600, 300);

                const div = document.createElement('div');
                div.className = "bg-white shadow-lg rounded-2xl overflow-hidden mt-4";
                div.innerHTML = `
                    <div class="relative">
                        <img alt="${w.title}" class="w-full object-cover" style="height: 10.5rem;" src=""/>
                        <div class="absolute inset-0 bg-hero-gradient"></div>
                        <div class="absolute bottom-0 left-0 p-4">
                            <p class="text-white text-xl font-bold leading-tight">${w.title}</p>
                            <div class="flex items-center mt-1.5">
                                <span class="material-icons text-red-400 mr-1" style="font-size: 18px;">favorite_border</span>
                                <p class="text-white text-sm font-medium"> Tercih edilme oranı: %${championPercentage} </p>
                            </div>
                        </div>
                    </div>`;
                const imgEl = div.querySelector('img');
                loadImageAndSetSrc(imgEl, otherImageUrl, w.title); // Use loadImageAndSetSrc for this too
                resultsCardContainer.appendChild(div);
            });
        } else {
            console.error("Sonuç kart konteyneri bulunamadı.");
        }
        showScreen('results');
    }

    function displayFinishScreen() {
        if (!champion) {
            console.warn("Bitiş ekranı için şampiyon yok. Fallback.");
            if (wishes.length > 0) champion = wishes[0]; // Fallback to first wish if no champion
            else {
                if(winningWishTextFinishElement) winningWishTextFinishElement.textContent = "Turnuva tamamlandı! #UtopiArena";
                if(moreDreamsContainer) moreDreamsContainer.innerHTML = '';
                showScreen('finish');
                return;
            }
        }
        if(winningWishTextFinishElement) winningWishTextFinishElement.textContent = `En çok oy alan haber: ${champion.title}\nBu hayal artık sadece senin değil, hepimizin dileği.\nPaylaş, belki bir gün hep birlikte gerçeğe dönüştürürüz. ✨`;
        if(moreDreamsContainer) {
            moreDreamsContainer.innerHTML = '';
            const otherWishes = [...wishes].filter(w => w.id !== champion.id);
            shuffleArray(otherWishes);

            for(let i=0; i<Math.min(3, otherWishes.length); i++){
                const d=otherWishes[i];
                if(!d || !d.title) continue;
                const moreDreamImageUrl = getImageUrl(d.imageSeed, 400, 225);

                const div = document.createElement('div');
                div.className = "flex flex-col gap-3 rounded-xl min-w-[280px] max-w-[280px] bg-white shadow-lg p-4";
                div.innerHTML = `
                    <div class="w-full overflow-hidden rounded-lg" style="height: 165.375px;">
                        <img src="" alt="${d.title}" class="w-full h-full object-cover">
                    </div>
                    <p class="text-[#0d131b] text-base font-medium leading-normal flex-grow card-description-clamp" style="-webkit-line-clamp: 3; min-height: calc(1.4em * 3); max-height: calc(1.4em * 3 + 2px);">${d.title}</p>
                    <button data-wish-id="${d.id}" class="more-dreams-wish-button mt-auto flex items-center justify-center w-full h-10 rounded-lg bg-rose-100 text-rose-600 hover:bg-rose-200 transition-colors duration-200 text-sm font-semibold">
                        <span class="material-icons text-sm mr-1">favorite_border</span> Bunu dile!
                    </button>`;
                const imgEl = div.querySelector('img');
                loadImageAndSetSrc(imgEl, moreDreamImageUrl, d.title); // Use loadImageAndSetSrc for this too
                moreDreamsContainer.appendChild(div);
            }
            // Add event listeners for "Dile!" buttons
            document.querySelectorAll('.more-dreams-wish-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const wishId = event.currentTarget.dataset.wishId;
                    const wishedItem = wishes.find(w => w.id == wishId);
                    if (wishedItem) alert(`"${wishedItem.title}" dileğini tuttun! Belki bir sonraki UtopiArena'da o şampiyon olur!`);
                });
            });
        }
        showScreen('finish');
    }

    // Event Listeners
    if(startGameButton) startGameButton.addEventListener('click', () => resetGameAndPlay(true));

    if (proceedFromOnboardingButton) {
        proceedFromOnboardingButton.addEventListener('click', () => {
            hideModal(onboardingModal, onboardingModalContent, onboardingModalBackdrop, () => {
                updateProgressBar();
                loadNextMatchUI();
                showScreen('game');
            });
        });
    }

    gameScreenCards.forEach(card => card.addEventListener('click', () => handleCardSelection(card)));
    if(closeWinnerPopupButton) closeWinnerPopupButton.addEventListener('click', () => hideModal(screens.winnerPopup, winnerPopupContentContainer, null, displayResultsScreen));
    if(winnerToResultsButton) winnerToResultsButton.addEventListener('click', () => hideModal(screens.winnerPopup, winnerPopupContentContainer, null, displayResultsScreen));
    if(closeSponsoredPopupButton) closeSponsoredPopupButton.addEventListener('click', () => {
        hideModal(screens.sponsoredPopup, sponsoredPopupContent, null, () => {
            isSponsoredInterstitialActive = false;
            if (screens.game) {
                screens.game.classList.remove('sponsored-round-theme');
                document.body.classList.remove('bg-[#F0F4F8]');
                document.body.classList.add('bg-slate-50');
            }
            updateProgressBar();
            loadNextMatchUI();
        });
    });

    // Generic share function
    const genericShareFunction = () => {
        if(navigator.share && champion) {
            navigator.share({
                title: '🏆 UtopiArena Şampiyonu!',
                text: `Benim UtopiArena hayalim ve şampiyonu: "${champion.title}"! Sen de oyna ve kendi ütopyanı seç! #UtopiArena`,
                url: window.location.href
            })
            .catch(error => console.log('Paylaşım hatası:', error));
        } else if (champion) {
            // Fallback for browsers that don't support Web Share API
            alert(`Şampiyon hayal: ${champion.title}!\n\n"${champion.title}" dileğini arkadaşlarınla paylaşarak bu harika geleceği yayabilirsin! #UtopiArena`);
        } else {
            alert("Paylaşılacak bir şampiyon bulunamadı.");
        }
    };
    if(winnerShareButtonPopup) winnerShareButtonPopup.addEventListener('click', genericShareFunction);
    if(shareChampionButtonFinish) shareChampionButtonFinish.addEventListener('click', genericShareFunction);

    // Navigation buttons
    if(globalHowToPlayButton) globalHowToPlayButton.addEventListener('click', () => showScreen('howToPlay'));
    if(closeHowToPlayButton) closeHowToPlayButton.addEventListener('click', () => showScreen(previousScreenId || 'game')); // Go back to previous screen or game

    if(navHomeButton) navHomeButton.addEventListener('click', (e) => { e.preventDefault(); showScreen('start'); });

    if(navPlayButton) navPlayButton.addEventListener('click', (e) => {
        e.preventDefault();
        // Determine if we should resume current game or start new one
        const isGameRelatedScreen = currentScreenId === 'game' ||
                                        (screens[previousScreenId]?.id === 'gameScreen' &&
                                         (currentScreenId === 'howToPlay' ||
                                          currentScreenId === 'stageTransitionModal' ||
                                          currentScreenId === 'winnerPopupScreen' ||
                                          currentScreenId === 'sponsoredPopupScreen'));

        if (isGameRelatedScreen && !champion) { // If game is active or was paused, and not finished
            showScreen('game');
        } else { // Game is finished or navigated away, start new
            resetGameAndPlay();
        }
    });

    if(navResultsButton) navResultsButton.addEventListener('click', (e) => { e.preventDefault(); displayResultsScreen(); });
    const finishPlayAgainButton = document.getElementById('finishPlayAgainButton');
    if(finishPlayAgainButton) finishPlayAgainButton.addEventListener('click', () => { resetGameAndPlay(); });

   // Initial setup on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Show loading screen immediately
        loadingScreen.classList.remove('hidden-screen', 'opacity-0');
        loadingScreen.classList.add('active', 'opacity-100');
        document.body.classList.add('loading-screen-active'); // Add a class to body to prevent scroll if needed

        // Get images to preload for the initial sequence
        managePreloads('loadingScreen');

        // Define the minimum time the loading screen should be displayed
        const fixedLoadingBarDuration = 3500; // 3.5 seconds
        const minDisplayTimePromise = new Promise(resolve => setTimeout(resolve, fixedLoadingBarDuration));

        // Start preloading images in the background.
        const backgroundPreloadPromise = preloadImages(imagesToPreloadQueue);

        // Animate loading bar to 100% over a fixed duration
        if (loadingProgressBarFill) {
            // Ensure initial state is 0% before applying transition and final width
            loadingProgressBarFill.style.width = '0%';
            setTimeout(() => { // Apply transition and final width after a slight delay
                loadingProgressBarFill.style.transition = `width ${fixedLoadingBarDuration / 1000}s ease-out`;
                loadingProgressBarFill.style.width = '100%';
            }, 50); // A small delay (e.g., 50ms) is enough for the browser to render the initial state
        }

        // Wait for both the minimum display time AND the background preloading to finish
        Promise.all([backgroundPreloadPromise, minDisplayTimePromise])
            .then(() => {
                // Once both conditions are met, hide loading screen and show start screen
                loadingScreen.classList.remove('active', 'opacity-100');
                loadingScreen.classList.add('opacity-0');
                document.body.classList.remove('loading-screen-active');

                setTimeout(() => {
                    loadingScreen.classList.add('hidden-screen');
                    showScreen('start'); // Show the start screen
                }, 500); // Wait for fade-out animation
            })
            .catch(error => {
                console.error("Initial loading process failed:", error);
                // In case of an error, still proceed to start screen after the fixed animation
                loadingScreen.classList.remove('active', 'opacity-100');
                loadingScreen.classList.add('opacity-0');
                document.body.classList.remove('loading-screen-active');
                setTimeout(() => {
                    loadingScreen.classList.add('hidden-screen');
                    showScreen('start');
                }, 500);
            });

        updateBottomNav(); // Initial navigation visibility and padding update
    });

    // Update navigation visibility and padding on window resize
    window.addEventListener('resize', updateBottomNav);
</script>
</body>
</html>
